<!--
Copyright 2017 Tilman Ginzel, AOE GmbH

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
	<style>
            #mainContainer {
                font-family: Helvetica, Arial, sans-serif;
                width: 800px;
                padding-top: 3px;
                margin: auto;
                margin-top: 20px;
                font-size: 14px;
                font-family: Helvetica;
                background: rgb(53, 60, 70);
                border-radius: 6px
        }
        html {
            background-image: url(http://blog.hostbaby.com/wp-content/uploads/2013/07/scuffedstatic_blue_1920x1234.jpg);
        }
        
        hr {
            border-color: #72a9ce;
            border-radius: 7px;
            height: 1px;
            background-color: #36a2eb;
        }
        
        h1 {
            font-weight: 300;
            margin: 24px 0px 8px 0px;
            font-size: 32px;
            word-wrap: break-word;
        }
        
        h2 {
            margin-top: 12px;
            margin-left: 10px;
            margin-right: 10px;
            font-size: 22px;
            font-weight: 300;
            font-style: italic;
            border-radius: 6px;
            text-align: center;
            color: #fafafa;

        }
        
        h3 {
            
            font-size: 22px;
            font-weight: 300;
            font-style: italic;
            margin-top: 24px;
            margin-bottom: 4px;
            color: white;
            margin-left: 14px;
        }
        
        p {
            margin: 0;
        }
        
        /* table {
            width: 100%;
        } */
        
        th {
            background: #c0d8e8;
            padding: 6px;
            border-radius: 16px;
            border: 2px solid #171a21;
            text-align: center;
            font-style: italic
        }
        
        td {
            padding: 6px;
            background-color: #FAFAFA;
            font-size: 13px;
            line-height: 15px;
            max-width: 500px;
            word-wrap: break-word;
        }
        
        tr.error td, td.error {
            background-color: #FFC107 !important;
        }
        
        tr.failure td, td.failure {
            color: #E53935;
        }
        
        td.error, td.failure {
            font-weight: bold;
        }
        
        td.passed {
            color: #2E7D32;
        }
        
        div.footer {
            /* margin: 24px 0px 24px 0px; */
            /* padding-top: 24px; */
            /* border-top: 1px solid #DDDDDD; */
            text-align: center;
            font-size: 13px;
            margin-top: 10px;
            padding-bottom:10px;
            color: white;
        }
            /* margin-left: 10px; */
            /* margin-right: 10px;
        }
        
        span.date-test-ran {
            font-size: 13px;
        }
        
        ul {
            list-style-type: square;
        }
        
        li {
            margin: 3px 0px 3px 0px;
        }
        
        /* h3 {
            margin-top: 48px;
        } */
        
        p {
            margin: 0;
        }
        
        p.date-test-ran {
            font-size: small;
            font-style: italic;
            color: white;
            margin-left: 14px;
            margin-bottom: 10px;
        }
        
        table.features-table {
            width: 800px;
            table-layout: fixed;
        }
        
        table.summary-table {
            width: 780px;
            text-align: left;
            font-weight: bold;
            font-size: small;
            border-radius: 6px;
            margin-right: 10px;
            margin-left: 10px;
            margin-right: 10px;
           
        }
        
        table.summary-table th {
            background: #c0d8e8;
            padding: 6px;
            border-radius: 16px;
            border: 2px solid #171a21;
            text-align: center;
            font-style: italic;
        }
        
        table.summary-table td {
            background: #5b6777;
            padding: 6px;
            border-radius: 16px;
            border: 2px solid #313a38;
            border: 2px solid #353c46;
            color: #fdfdfd;
            text-align: center;
            font-style: italic;
        }
        
        pre {
            line-height: 1em;
            white-space: pre-wrap;
            color: antiquewhite;    
        }
        
        pre.code {
            overflow-y: scroll;
            white-space: pre;
        }
        
        pre.stacktrace {
            line-height: 0.8em;
            overflow-y: scroll;
            white-space: pre;
        }
        
        pre.narrative {
            font-family: inherit;
            font-size: 16px;
            line-height: 20px;
            color: #444;
            margin-top: 4px;
        }
        
        h4.spec-title {
            margin-bottom: 8px;
        }
        
        .margin-bottom-16 {
            margin-bottom: 16px;
        }
        
        .feature-description {
            font-size: large;
            background: lightblue;
            padding: 4px;
        }
        
        .feature-toc-error {
            color: #F89A4F;
        }
        
        .feature-toc-failure {
            color: #FF8080;
        }
        
        .feature-toc-ignored {
            color: lightgray;
        }
        
        .feature-toc-pass {
            color: green;
        }
        
        .feature-description.error {
            background: #F89A4F;
        }
        
        .feature-description.failure {
            background: #FF8080;
        }
        
        .feature-description.ignored {
            background: lightgray;
        }
        
        .feature-description.ignored .reason {
            color: black;
            font-style: italic;
            font-size: small;
        }
        
        div.issues {
            color: black;
            font-weight: bold;
            font-size: small;
        }
        
        div.problem-description {
            padding: 10px;
            background: #5a687b;
            border-radius: 10px;
            border: 2px solid #939fb1;
            margin-left: 10px;
            margin-right: 10px;
        }
        
        div.problem-header {
            font-weight: bold;
            color: #ffebd1;
            font-size: 15px;
        }
        
        div.problem-list {
        
        }
        
        table.ex-table th {
            background: lightblue;
            padding: 0px 5px 0px 5px;
        }
        
        table.ex-table td {
            background: #E0E0E0;
            padding: 0px 5px 0px 5px;
        }
        
        table td {
            min-width: 50px;
            background-color: #353c46;
        }
        
        col.block-kind-col {
            width: 70px;
        }
        
        span.spec-header {
            font-weight: bold;
        }
        
        span.back-to-top {
            float: right;
            font-size: 60%;
        }
        
        div.spec-text {
            /*color: green;*/
        }
        
        p.spec-status {
            font-style: italic;
        }
        
        .ignored {
            color: gray;
        }
        
        td.ex-result {
            text-align: center;
            background: white !important;
        }
        
        .ex-pass {
            color: darkgreen;
        }
        
        .ex-fail {
            color: red;
            font-weight: bold;
        }
        
        td.block-kind {
            margin: 2px;
            font-style: italic;
        }
        
        td.block-text {
            width: 100%;
        }
        
        td.block-text > p {
            margin-top: 5px;
        }
        
        div.footer {
            text-align: center;
            font-size: small;
        }
        
        div.geb-artifacts {
            font-size: 13px;
            width: 100%;
            margin-top: 12px;
        }
        
        div.geb-artifacts table {
            text-align: left;
            width: 773px;
            border-radius: 6px;
            margin-left: 14px;
            margin-right: 20px;
        }
        
        tr.geb-failure {
            background-color: #FF8080;
        }
        
        /* toggle stacktrace div */
        input.toggle-stacktrace-checkbox {
            display: none;
        }
        
        input.toggle-stacktrace-checkbox:checked + label + div {
            display: none;
        }
        
        input.toggle-stacktrace-checkbox + label:before {
            content: "Hide "
        }
        
        input.toggle-stacktrace-checkbox:checked + label:before {
            content:" Show "
        }


        /* ------------------------ */
        input.toggle1-stacktrace1-checkbox1 {
            display: none;
        }
        
        input.toggle1-stacktrace1-checkbox1:checked + label + div {
            display: none;
        }
        
        input.toggle1-stacktrace1-checkbox1 + label:before {
            content: "Hide "
        }
        
        input.toggle1-stacktrace1-checkbox1:checked + label:before {
            content:" Show "
        }
        /* ----------------------------- */
        .geb-artifacts td {
            background: #5b6777;
            padding: 6px;
            border-radius: 16px;
            border: 2px solid #313a38;
            border: 2px solid #353c46;
            color: #fdfdfd;
            text-align: center;
            font-style: italic;
        }
        label.toggle-stacktrace-label, label.toggle1-stacktrace1-label1 {
            border-radius: 4px;
            border: 1px solid #c0d8e8;
            font-size: 10px;
            display: inline-block;
            padding: 2px 5px;
            cursor: pointer;
            color: #f9f9f9;
        }
        a {
            color: white;
        }
        #wrapper1,#wrapper2 {
            width: 250px;
            height: 250px;
        }
        div#wrapper3 {
            width: 250px;
            height: 200px;
            padding-top: 10px;
        }
            .wrapper{
            float: left;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        /* #wrapper1,#wrapper1{
            float: left;
        } */
        h2.narrative {
            text-align: left;
            font-size: 14px;
            border-radius: 6px;
            border-color: #dad7d7;
            background-color: #5b6777;
            padding: 8px;
        }
        li {
            color: #ffebd1;
            font-weight: bold;
        }
        #chart3 {
            height: 250px;
            width:250px;
        }
        
            </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <%
    String ImAJavaVariable = "Bob";
  %>
  
    <script language="javascript">
            window.addEventListener("load",function(){
                console.log("The code is reaching here")
                var a = document.querySelector('h2').innerText;
                a = a.split(' ');
                var reportName = a[2];
                var arr = [];
                var arr1= [];
                for(var i =0;i < reportName.length;i++){
                if(reportName[i] == reportName[i].toUpperCase())
                arr.push(i)
            }
                for(var i =0;i<arr.length;i++){
                arr1.push(reportName.slice(arr[i],arr[i+1]))
            }
                reportName = a[0]+ " "+a[1]+" "+arr1.join(" ");
                document.querySelector('h2').innerText = reportName;
            });   
            window.onload = function() {
                var ImAJavascriptVariable = '<%=ImAJavaVariable%>';
                var passCount = document.getElementById('p').value;
                var failCount = document.getElementById('f').value;
                var errorCount = document.getElementById('e').value;
                new Chart(document.getElementById("pie-chart"), {
        type: 'pie',
        data: {
          labels: ["Pass", "Failure", "Error"],
          datasets: [{
            label: "Population (millions)",
            backgroundColor: ["#00e396", "#ff4560","#F8ED08"],
            data: [passCount,failCount,errorCount],
            borderColor:'#000000',
          }]
        },
        options: {
          title: {
            display: false,
            text: 'Chart 1',
            fontColor: 'white'
          },
          legend: {
            display: true, 
            labels: {
                fontColor: 'white'
            }
        },
        }
    });

    new Chart(document.getElementById("doughnut-chart"), {
        type: 'doughnut',
        data: {
          labels: ["Pass", "Failure", "Error"],
          datasets: [{
            label: "Population (millions)",
            backgroundColor: ["#008ffb", "#ff6384","#F8ED08"],
            data: [passCount,failCount,errorCount],
            borderColor:'#000000'
          }]
        },
        options: {
          title: {
            display: false,
            text: 'Chart 2',
            fontColor: 'white'
          },
          legend:{
              display:true,
              labels: {
                fontColor: 'white'
            }
          }
          
        }
    });

    
    }
    
                </script>
</head>
<body id="top">
<div id= "mainContainer"> 
        
        
<%
def stats = utils.stats( data )
def gebUtils = new com.aoe.gebspockreports.GebReportUtils()
def gebReport = gebUtils.readGebReport()
def specReport = gebReport.findSpecByLabel(utils.getSpecClassName(data))

def writeIssuesOrSees = { issues, description ->
if ( issues?.value() ) { %>
<div class="issues">
    <div>$description</div>
    <ul> <%
        issues.value().each { issue ->
        %>
        <li>
            <% if (utils.isUrl(issue)) { %>
            <a href="$issue">$issue</a>
            <% } else { out << issue } %>
        </li> <%
        } %>
    </ul>
</div> <%
}
}

def writeStackTrace = { error, index, featureName, problem1 ->
    def uniqueId = "${featureName.hashCode()}-${index}" %>
    <pre>$error</pre>
    <input type="checkbox" id="toggle-stacktrace-checkbox-$uniqueId" class="toggle-stacktrace-checkbox" checked />
    <label for="toggle-stacktrace-checkbox-$uniqueId" class="toggle-stacktrace-label" >Stacktrace</label>
    <div>
        <pre class="stacktrace"><% error.getStackTrace().each { stackTraceElement -> %>
$stackTraceElement
        <% } %>
        </pre>
    </div>
    <input type="checkbox" id="toggle1-stacktrace1-checkbox1-$uniqueId" class="toggle1-stacktrace1-checkbox1" checked />
    <label for="toggle1-stacktrace1-checkbox1-$uniqueId" class="toggle1-stacktrace1-label1" >Data Values</label>
    <div>
        <pre class="stacktrace1"> ${problem1.dataValues}
        </pre>
    </div>
<% } %>
<%
        String a = utils.getSpecClassName(data);
		String[] b = a.split("\\.");
		def repName = b[b.length-1];
%>
<h2>Report For ${repName}</h2>
<hr>
<input type="hidden" id="reptt" onload="reportChange()">

<div class="summary-report">
    <h3>Summary:</h3>
    <p class="date-test-ran">Created on ${new Date()} by ${System.properties['user.name']}</p>
          <% features.eachFeature { name, result, blocks, iterations, params -> 
              def count=iterations.size()   
              def failure = iterations.findAll { it.failures || it.errors }.size()
              
              def passed = iterations.size() - failure
              def successCalc=(passed/(count * 1.0)) * 100
              int success = (int)Math.round(successCalc)
			  def errors1 =  iterations.findAll {it.errors }.size()
			  def errors = failure - errors1
			  
          %>
          <input type="hidden" id="p" value="${passed}">
          <input type="hidden" id="f" value="${failure}">
          <input type="hidden" id="e" value="${errors}">
          <input type="hidden" id="perc" value="${success}">
    <table class="summary-table">

        <thead>
        <tr>
            <th>Executed features</th>
			<th>Passed</th>
            <th>Failures</th>
			<th>Errors</th>
            <th>Success rate</th>
            <th>Time</th>
			
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>$count</td>
			<td>$passed</td>
            <td>$failure</td>
			<td>$errors</td>
            <td>$success%</td>
            <td>${fmt.toTimeDuration(stats.time)}</td>
			
        </tr>
        </tbody>
    </table>
	<% } %>
</div>
<%
// spec title and narrative
def specTitle = utils.specAnnotation(data, spock.lang.Title)?.value() ?: ''
def narrative = (data.info.narrative ?: '')

if (specTitle) { %> <h4 class="spec-title">$specTitle</h4> <% }
if (narrative) { %> <h3>Test Cases Description:</h3><h2 class="narrative"><pre>$narrative</pre></h2> <% }

// issues/see annotations
writeIssuesOrSees(utils.specAnnotation(data, spock.lang.Issue), 'Issues')
writeIssuesOrSees(utils.specAnnotation(data, spock.lang.See), 'See')
%>

<div class="wrapper" id="wrapper1">
    <canvas id="pie-chart" style="width:250px;height:250px;"></canvas>
</div>
<div class="wrapper" id="wrapper2">
    <canvas id="doughnut-chart" style="width:250px;height:250px;"></canvas>
</div>
<div class="wrapper" id="wrapper3">
    <div id="chart3"></div>
</div>
<script>
    var successPercentage = document.getElementById('perc').value;
    var options = {
            chart: {
                height: 300,
                 width: 300,
                type: 'radialBar',
            },
            plotOptions: {
                radialBar: {
                    startAngle: -135,
                    endAngle: 135,
                    dataLabels: {
                        name: {
                            fontSize: '13px',
                            color: '#ffffff',
                            offsetY: 80
                        },
                        value: {
                            offsetY: 46,
                            fontSize: '13px',
                            color: '#ffffff',
                            formatter: function (val) {
                                return val + "%";
                            }
                        }
                    }
                }
            },
            fill: {
            //   colors:'#f31456',
                gradient: {
                    enabled: true,
                    shade: 'dark',
                    shadeIntensity: 0.15,
                    inverseColors: false,
                    
                    opacityFrom: 1,
                    opacityTo: 1,
                    stops: [0, 50, 65, 99]
                },
            },
            stroke: {
                dashArray: 4
            },
            series: [successPercentage],
            labels: ['Success Rate'],
            
        }

       var chart = new ApexCharts(
            document.querySelector("#chart3"),
            options
        );
        
        chart.render();
</script>
<!--
<h3>Features:</h3>
<ul id="toc">
    <% features.eachFeature { name, result, blocks, iterations, params ->
    def classSuffix = result.toLowerCase()
    classSuffix = classSuffix.startsWith('fail') ? 'failure' : classSuffix
    %>
    <li><a href="#${name.hashCode()}" class="feature-toc-$classSuffix">$name</a></li>
    <% } %>
</ul>
-->
<table class="features-table">
    <colgroup>
        <col class="block-kind-col" />
        <col class="block-text-col" />
    </colgroup>
    <tbody>
    <%
    def featureCount = 0
    features.eachFeature { name, result, blocks, iterations, params ->
    def failedIterations = iterations.findAll { it.dataValues || it.errors }
    def problems = iterations.findAll { it.errors }
    def isFailure = result in ['FAIL', 'FAILURE']
    def isError = result == 'ERROR'
    def isIgnored = result == 'IGNORED'
    def cssClass = isIgnored ? 'ignored' : (isError ? 'error' : (isFailure ? 'failure' : ''))
	 def failureCondt = iterations.findAll { it.failures || it.errors }.size()

    featureCount += isIgnored ? 0 : 1
    def gebFeatureReport = specReport?.findFeatureByNumberAndName(featureCount, name)
    def gebArtifacts = gebFeatureReport?.artifacts
    %>
    <!-- print feature title and issues/see annotations-->
    <tr>
        <td colspan="10">
            <div>
			<% if(failureCondt>0){ %>
			
			<h3> Problem Description: </h3>
             <%}%>
			 <!--<span>$name</span>
                <span class="back-to-top"><a href="#top">To top</a></span>-->
                <%
                def ignoreReason = description.getAnnotation(spock.lang.Ignore)?.value()
                if (ignoreReason) {
                %> <div><span class="reason">$ignoreReason</span></div>  <%
                }
                writeIssuesOrSees(description.getAnnotation(spock.lang.Issue), 'Issues')
                writeIssuesOrSees(description.getAnnotation(spock.lang.See), 'See')
                %>
            </div>
        </td>
    </tr>

    <!-- print given, when, then, ... blocks -->
    <% blocks.forEach { block -> %>
    <tr class="${isIgnored ? 'ignored' : ''}">
        <td class="block-kind" colspan="1">
            <p>$block.kind</p>
        </td>
        <td class="block-text" colspan="9">
            <p>$block.text</p>
            <% if (block.sourceCode) {
                %><pre class="code"><%
                block.sourceCode.each { out << it << System.getProperty("line.separator") }
                %></pre><%
            }
            %>
        </td>
    </tr>
    <% } %>

    
    <!-- print data tables if feature failed -->
	<!--
    <%
    if (failureCondt>0) {
    %>
    <tr>
        <td colspan="1">Params:</td>
        <td colspan="7">
            <div class="spec-examples">
                <table class="ex-table">
                    <thead>
                    <tr>
                        <% params.forEach { param -> %> <th class="ex-header">$param</th> <% }%>
                    </tr>
                    </thead>
                    <tbody>
                    <% failedIterations.forEach { iteration -> %>
                    <tr class="ex-${iteration.errors ? 'fail' : 'pass'}">
                        <% iteration.dataValues.each { dataValue -> %>
                        <td class="ex-value">$dataValue</td>
                        <% } %>
                        <td class="ex-result">${iteration.errors ? 'FAIL' : 'OK'}</td>
                    </tr>
                    <% }%>
                    </tbody>
                </table>
            </div>
        </td>
	
        <%
        def failCount = iterations.findAll { it.failures || it.errors }.size()
        def passedCount = iterations.size() - failCount
        %>
		<!--	
        <td colspan="2">
            <p class="spec-status">$passedCount/${iterations.size()} passed</p>
        </td>
    </tr>
    <% } %>
	-->
  
    <!-- print geb artifacts-->
    <!-- print problems -->
    <%
    int ct1=0
    int ct2=0   
    int sz = 0
    def failure = iterations.findAll { it.failures || it.errors }.size()
    int [] arrr = new int[failure]
    int [] dum =  new int[failedIterations.size()]
    //def failedIterations = iterations.findAll { it.dataValues || it.errors }
    def z = iterations.findAll { it.errors}.size()
    failedIterations.forEach { iteration ->
        value = iteration.errors ? ct1 : 10000
        dum[ct1] = value
        ct1=ct1+1
    }
    int j=0
    for(int i=0;dum.length >i;i++){
        if(dum[i]!=10000){
            arrr[j] = dum[i]
            j=j+1
    }
    }


    %>  
    <%
    if (problems) {
    %>
    <tr>
        <td colspan="10">
            <div class="problem-description">
                <div class="problem-header">The following problems occurred:</div>
                <div class="problem-list">
                    <ul>
                        <% problems.eachWithIndex { problem, index ->
                            if (problem.dataValues) { %>
                                <!-- <li>Input: $problem.dataValues</li>-->
                                <ul class="margin-bottom-16">
                                    <% problem.errors.each { error ->  %>
                                    <li>
                                        Failed at Test Case :${arrr[index++]+1}<% writeStackTrace(error, index, name, problem) %>
                                    </li>
                                    <% } %>
                                </ul>
                            <% } else {
                                problems.errors.forEach { error -> %>
                                <li><% writeStackTrace(error[0], index, name) %></li>
                            <% }
                            }
                        } %>
                    </ul>
                </div>
            </div>
        </td>
    </tr>
    <% }
    gebFeatureReport?.addedToReport = true
    } %>
    </tbody>
</table>

<%
features.eachFeature { name, result, blocks, iterations, params ->
def failureCondt1 = iterations.findAll { it.failures || it.errors }.size()
if (failureCondt1>0) {
%>

<h3>Error ScreenShots:</h3>
<div class="geb-artifacts">
    <table>
        <thead>
        <tr>
            <th>Label</th>
            <th>Image</th>
        </tr>
        </thead>
		<%def gebFeatureReport1 = specReport?.findFeatureByNumberAndName(featureCount, name)
                    def gebArtifacts1 = gebFeatureReport1?.artifacts
                    int counter =1 
                    %>
		
                    <% if (gebArtifacts1) { %>
                        <% gebArtifacts1.sort { it.number }.each { artifact ->
                            def label = artifact.label?.replaceFirst(name+"-", '')
                            def trCssClass = label == 'failure' ? 'geb-failure' : ''
                            def imageFile = "./" + artifact.files.find { it.endsWith('png') }   
                           def imgArray = imageFile.split('\\\\');
                            def imgName = "./"+imgArray[imgArray.length-1]		
                    
            %>

        
		
		 <tbody>
                    
                    <tr >
                        <td>Screenshot ${counter++}</td>
                        <td><a href="$imgName">Click Me</a></td>
                    </tr>
                    <%
                    } %>
                    </tbody>
					<%
                    } %>
		<%def unassignedArtifacts = specReport?.getUnassignedGebArtifacts()
		if(unassignedArtifacts){
		%>
        <tbody>
                <% unassignedArtifacts.forEach { artifact ->
                    def label = artifact.label
                     def imageFile = "./" + artifact.files.find { it.endsWith('png') }   
                                    def imgArray = imageFile.split('\\\\');
                                    def imgName = "./"+imgArray[imgArray.length-1]		
            
                    %>
        <tr>
            <td>Screenshot ${counter++}</td>
            <td><a href="$imgName">Click Me</a></td>
        </tr>
		<% } %>
        </tbody>
		 <%
        } %>
    </table>
</div>
<% } %>
<% } %>

<hr>
<div class="footer">
    Generated by <a href="https://github.com/renatoathaydes/spock-reports">Athaydes Spock Reports.</a>.
    Modifications by Xmplar Geb-Team.
</div>
</div>
</body>
</html>
